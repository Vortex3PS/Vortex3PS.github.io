<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <title>Vortex Personale Noter</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        #staff-content {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 2px solid #4CAF50;
            border-radius: 10px;
            background-color: #fff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        #error-message {
            color: red;
        }
        #noteArea {
            width: 90%;
            height: 150px;
            margin-top: 20px;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 16px;
            resize: none;
        }
        #ideaInput {
            width: 90%;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            font-size: 16px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        #check-out-btn {
            background-color: #f44336;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        #check-out-btn:hover {
            background-color: #d32f2f;
        }
        /* Popup styles */
        #nfc-popup {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4); /* Black with transparency */
            text-align: center;
        }
        #popup-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); /* Shadow for popup */
        }
        #close-popup {
            background-color: #f44336; /* Red for cancel button */
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px; /* Space above button */
        }
        #close-popup:hover {
            background-color: #d32f2f; /* Darker red on hover */
        }
    </style>
</head>
<body>
    <h1>Personale Login</h1>
    <button onclick="openNfcPopup()">Scan Kort</button>
    
    <div id="nfc-popup">
        <div id="popup-content">
            <h2>Scan Kort</h2>
            <p>Placer kortet tæt på telefonen.</p>
            <button id="close-popup" onclick="closePopup()">Afbryd</button>
        </div>
    </div>

    <div id="staff-content">
        <h2 id="welcome-message"></h2>

        <!-- Fixed Announcement Section (Editable Directly in HTML) -->
        <h3>Seneste Annoncering</h3>
        <p id="announcementMessage">Her kan du skrive dine annonceringer til personalet.</p>

        <!-- Notes and Ideas Input -->
        <textarea id="noteArea" placeholder="Skriv dine noter her..."></textarea><br>
        <button onclick="saveNotes()">Gem noter</button>
        <p id="success-message" style="color: green;"></p>

        <h3>Tilføj Ideer</h3>
        <input type="text" id="ideaInput" placeholder="Skriv din idé her...">
        <button onclick="submitIdea()">Send Idé</button>
        <p id="idea-message" style="color: green;"></p>

        <button id="check-out-btn" onclick="checkOut()">Udtjek</button>
    </div>

    <p id="error-message"></p>

    <script>
        // Define the expected staff IDs and their corresponding names
        const authorizedStaffIds = {
            "Vortex3PS-Pass-Owner-Markus": "Markus",
            "Vortex3PS-Pass-Co-Owner-Rani": "Rani",
            "Vortex3PS-Pass-Staff": "Staff"
        };

        let isCheckedIn = false; // Flag to track check-in status

        // Load notes from cookies on page load
        window.onload = function() {
            const savedNotes = getCookie("staffNotes");
            if (savedNotes) {
                document.getElementById("noteArea").value = savedNotes;
            }
        };

        function openNfcPopup() {
            // Show the NFC prompt popup
            document.getElementById("nfc-popup").style.display = "block";
        }

        async function authenticateUsingNFC() {
            if ('NDEFReader' in window) {
                const nfcReader = new NDEFReader();
                try {
                    await nfcReader.scan();
                    nfcReader.onreading = (event) => {
                        const decoder = new TextDecoder();
                        for (const record of event.message.records) {
                            const nfcData = decoder.decode(record.data);
                            
                            if (authorizedStaffIds[nfcData]) {
                                const userName = authorizedStaffIds[nfcData];
                                document.getElementById("welcome-message").textContent = `Velkommen ${userName} til personale note siden`;
                                document.getElementById("staff-content").style.display = "block";
                                document.getElementById("error-message").textContent = "";
                                closePopup(); // Close the popup on successful scan

                                // Check-in logic
                                if (!isCheckedIn) {
                                    isCheckedIn = true;
                                    logCheckIn(userName);
                                } else {
                                    document.getElementById("error-message").textContent = "Du er allerede tjekket ind.";
                                }
                            } else {
                                document.getElementById("error-message").textContent = "Ingen adgang.";
                                document.getElementById("staff-content").style.display = "none";
                                closePopup(); // Close the popup on unsuccessful scan
                            }
                        }
                    };
                } catch (error) {
                    console.error("NFC scan error:", error);
                    document.getElementById("error-message").textContent = "NFC scan fejlede.";
                    closePopup(); // Close the popup on scan failure
                }
            } else {
                alert("NFC er ikke understøttet.");
                closePopup(); // Close the popup if NFC is not supported
            }
        }

        function checkOut() {
            if (isCheckedIn) {
                logCheckOut();
                isCheckedIn = false; // Reset the check-in status
                document.getElementById("welcome-message").textContent = ""; // Clear welcome message
                document.getElementById("staff-content").style.display = "none"; // Hide staff content
            } else {
                document.getElementById("error-message").textContent = "Du er ikke tjekket ind.";
            }
        }

        function logCheckIn(userName) {
            const currentTime = new Date().toLocaleString();
            const message = `${userName} tjekkede ind kl. ${currentTime}`;
            sendToDiscord(message); // Send check-in message to Discord webhook
        }

        function logCheckOut() {
            const currentTime = new Date().toLocaleString();
            const message = `${userName} tjekkede ud kl. ${currentTime}`;
            sendToDiscord(message); // Send check-out message to Discord webhook
        }

        function submitIdea() {
            const idea = document.getElementById("ideaInput").value;
            if (idea) {
                sendToDiscord(`Idé: ${idea}`); // Send idea to Discord webhook
                document.getElementById("idea-message").textContent = "Idé sendt!";
                document.getElementById("ideaInput").value = ""; // Clear input field
            } else {
                document.getElementById("idea-message").textContent = "Indtast en idé, før du sender.";
            }
        }

        function saveNotes() {
            const notes = document.getElementById("noteArea").value;
            setCookie("staffNotes", notes, 7); // Save notes in cookies for 7 days
            document.getElementById("success-message").textContent = "Noter gemt!";
        }

        function sendToDiscord(message) {
            // Replace with your Discord webhook URL
            const webhookUrl = "https://discord.com/api/webhooks/1302975455300944023/DubSBFg29M9_YVOQexe0xIS6lDJh9jrg3vYfCLIOjMmia9-PUoBxIG_9zsT47fF_5TIb";
            fetch(webhookUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ content: message })
            }).then(response => {
                if (!response.ok) {
                    console.error("Error sending message to Discord:", response);
                }
            }).catch(error => console.error("Fetch error:", error));
        }

        // Cookie management functions
        function setCookie(cname, cvalue, exdays) {
            const d = new Date();
            d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
            const expires = "expires=" + d.toUTCString();
            document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
        }

        function getCookie(cname) {
            const name = cname + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }

        function closePopup() {
            document.getElementById("nfc-popup").style.display = "none";
            authenticateUsingNFC(); // Call the NFC authentication when the popup is closed
        }
    </script>
</body>
</html>
